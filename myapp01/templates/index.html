{% extends 'layout.html' %}
{% load humanize %}
{% block css %}
    <style>
        /* è¡¨æ ¼æ ·å¼ä¼˜åŒ– */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            border: 1px solid #e8e8e8;
        }

        .data-table th {
            background-color: #fafafa;
            font-weight: 600;
            color: rgba(0, 0, 0, 0.85);
        }

        .data-table tr:hover {
            background-color: #f5f5f5;
        }

        .data-table .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .data-table .status.normal {
            background: #e6f7ff;
            color: #1890ff;
        }

        .data-table .status.hot {
            background: #fff7e6;
            color: #fa8c16;
        }

        /* å›¾è¡¨å®¹å™¨æ ·å¼ */
        .chart-container {
            background: #fff;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            height: 480px; /* å›ºå®šé«˜åº¦ */
            display: flex;
            flex-direction: column;
        }

        .chart-container > div {
            flex: 1;
            min-height: 400px;
        }

        /* ç»Ÿä¸€æ ‡é¢˜æ ·å¼ */
        .chart-title {
            margin-bottom: 1.5rem;
            text-align: center;
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .chart-container {
                height: auto;
                padding: 15px;
            }
        }
    </style>
{% endblock %}

{% block content %}
    <!-- æ•°æ®æ€»è§ˆ -->
<div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="data-card">
                <div class="d-flex align-items-center">
                    <div class="bg-primary text-white rounded-circle p-3 me-3">
                        <i class="fa fa-thumbs-up fa-2x"></i>
                    </div>
                    <div>
                        <h3 class="mb-0">{{ max_like_count|intcomma }}</h3>
                        <small class="text-muted">æœ€é«˜è¯„è®ºç‚¹èµæ•°</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="data-card">
                <div class="d-flex align-items-center">
                    <div class="bg-primary text-white rounded-circle p-3 me-3">
                        <i class="fa fa-star fa-2x"></i>
                    </div>
                    <div>
                        <h3 class="mb-0">{{ max_collects|intcomma }}</h3>
                        <small class="text-muted">æœ€é«˜æ”¶è—æ•°</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="data-card">
                <div class="d-flex align-items-center">
                    <div class="bg-primary text-white rounded-circle p-3 me-3">
                        <i class="fa fa-fire fa-2x"></i>
                    </div>
                    <div>
                        <h3 class="mb-0">{{ max_hot_value|intcomma }}</h3>
                        <small class="text-muted">æœ€é«˜çƒ­åº¦å€¼</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="data-card">
                <div class="d-flex align-items-center">
                    <div class="bg-primary text-white rounded-circle p-3 me-3">
                        <i class="fa fa-share-alt fa-2x"></i>
                    </div>
                    <div>
                        <h3 class="mb-0">{{ max_shares|intcomma }}</h3>
                        <small class="text-muted">æœ€é«˜åˆ†äº«æ•°</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾è¡¨åŒºåŸŸ -->
    <div class="row g-4">
        <div class="col-md-6">
            <div class="chart-container">
                <h5 class="chart-title">ğŸ“Š çƒ­æœçƒ­åº¦æ’è¡Œ</h5>
                <div id="hotBoardChart"></div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <h5 class="chart-title">ğŸ”¥ çƒ­æ¦œTOP3</h5>
                <div id="top3Chart"></div>
            </div>
        </div>
    </div>

    <!-- æ•°æ®è¡¨æ ¼ -->
    <div class="chart-container mt-4">
        <h5 class="chart-title">ğŸ“‹ æœ€æ–°èˆ†æƒ…æ•°æ®</h5>
<table class="table data-table">
            <thead>
                <tr>
                    <th>è§†é¢‘ID</th>
                    <th>æ–‡æ¡ˆ</th>
                    <th>ç”¨æˆ·æ˜µç§°</th>
                    <th>æ”¶è—</th>
                    <th>åˆ†äº«</th>
                    <th>çŠ¶æ€</th>
                </tr>
            </thead>
            <tbody>
                {% for video in latest_videos %}
                <tr>
                    <td>{{ video.video_id|truncatechars:15 }}</td>
                    <td>{{ video.caption|truncatechars:30 }}</td>
                    <td>{{ video.user }}</td>
                    <td>{{ video.collects|intcomma }}</td>
                    <td>{{ video.shares|intcomma }}</td>
                    <td>
                        <span class="status {% if video.popularity == 'çƒ­é—¨' %}hot{% else %}normal{% endif %}">
                            {{ video.popularity }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>
<script>
    // ç»Ÿä¸€é…ç½®å‚æ•°
    const commonGrid = {
        top: 80,
        bottom: 40,
        left: '10%',
        right: '10%',
        containLabel: true
    };

    // çƒ­æœçƒ­åº¦æ’è¡Œ
    function initHotBoardChart() {
        const chart = echarts.init(document.getElementById('hotBoardChart'));
        const hotData = {{ hotboards_json|safe }};

        const option = {
            tooltip: {
                trigger: 'axis',
                formatter: '{b}: {c} çƒ­åº¦å€¼'
            },
            grid: commonGrid,
            xAxis: {
                type: 'category',
                data: hotData.map(item => item.keyword),
                axisLabel: {
                    rotate: 45,
                    interval: 0,
                    hideOverlap: true
                },
                axisLine: { show: false },
                axisTick: { show: false }
            },
            yAxis: {
                type: 'value',
                name: 'çƒ­åº¦å€¼',
                axisLine: {
                    show: true,
                    lineStyle: {
                        color: '#666',
                        width: 1
                    }
                }
            },
            series: [{
                data: hotData.map(item => item.hot_value),
                type: 'bar',
                barWidth: '60%',
                itemStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                        {offset: 0, color: '#36a2eb'},
                        {offset: 1, color: '#9acfea'}
                    ])
                }
            }]
        };
        chart.setOption(option);
        return chart;
    }

    // çƒ­æ¦œTOP3
    function initTop3Chart() {
        const chart = echarts.init(document.getElementById('top3Chart'));
        const hotData = {{ hotboards_json|safe }};

        const top3Data = hotData
            .sort((a, b) => b.hot_value - a.hot_value)
            .slice(0, 3);

        const option = {
            tooltip: {
                trigger: 'item',
                formatter: '{b}: {c} çƒ­åº¦å€¼'
            },
            grid: commonGrid,
            xAxis: { show: false },
            yAxis: {
                type: 'category',
                data: top3Data.map(item => item.keyword),
                inverse: true,
                axisLine: {
                    show: true,
                    lineStyle: {
                        color: '#666',
                        width: 1
                    }
                }
            },
            series: [{
                type: 'bar',
                data: top3Data.map(item => item.hot_value),
                barWidth: 20,
                itemStyle: {
                    color: ({ dataIndex }) => [
                        '#ff6b6b', '#fbc531', '#2ecc71'
                    ][dataIndex],
                    borderRadius: [10, 10, 0, 0]
                },
                label: {
                    show: true,
                    position: 'right',
                    formatter: ({ dataIndex }) => [
                        'ğŸ¥‡ ', 'ğŸ¥ˆ ', 'ğŸ¥‰ '
                    ][dataIndex],
                    fontSize: 24
                }
            }]
        };
        chart.setOption(option);
        return chart;
    }

    // åˆå§‹åŒ–å›¾è¡¨
    let hotChart, top3Chart;
    window.addEventListener('load', () => {
        hotChart = initHotBoardChart();
        top3Chart = initTop3Chart();
    });

    // ä¼˜åŒ–å“åº”å¼
    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
            hotChart?.resize();
            top3Chart?.resize();
        }, 200);
    });
</script>
{% endblock %}